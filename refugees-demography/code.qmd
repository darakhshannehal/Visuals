---
title: "Demography data from {refugees}"
format: html
editor: visual
execute:
  warning: false
  message: false
---

```{r}
if (!require("pacman")) {
  install.packages("pacman")
}

#  Load packages
pacman::p_load(
  tidyverse,
  refugees,
  tidylog,
  ggview,
  ggtext,
  scico
)
```

```{r}
# Load demographics data from refugees package

demographics = refugees::demographics
glimpse(demographics) # Check data types


demographics$year = as.integer(demographics$year) # Convert year to integer
```

### Children under 5

```{r}
# Filter for children under 5 (f_0_4 and m_0_4 columns)
under_5 <- demographics |>
  filter(f_0_4 != 0 | m_0_4 != 0) |>
  select(year:coo_iso, pop_type, f_0_4, m_0_4) |>
  mutate(
    total = f_0_4 + m_0_4
  ) |>
  rename(
    female_under5 = f_0_4,
    male_under5 = m_0_4
  )
```

```{r}
#
selected_regions <- c(
  "COD",
  "SDN",
  "YEM",
  "MMR",
  "IRQ",
  "COL",
  "SOM",
  "UKR",
  "AFG",
  "SYR"
)

iso_to_country <- c(
  COD = "Congo (DRC)",
  SDN = "Sudan",
  YEM = "Yemen",
  MMR = "Myanmar",
  IRQ = "Iraq",
  COL = "Colombia",
  SOM = "Somalia",
  UKR = "Ukraine",
  AFG = "Afghanistan",
  SYR = "Syria"
)

# Filter the data to include only the selected countries
under_5_filtered <- under_5 |>
  filter(coo_iso %in% selected_regions)


under_5_heatmap <- under_5_filtered |>
  group_by(year, coo_iso) |>
  summarise(total = sum(total), .groups = "drop") |>
  mutate(country_name = iso_to_country[coo_iso])

country_order <- under_5_heatmap |>
  group_by(country_name) |>
  summarise(total_displacement = sum(total)) |>
  arrange(desc(total_displacement)) |>
  pull(country_name)

# Apply the order to the country_name factor for plotting
under_5_heatmap$country_name <- factor(
  under_5_heatmap$country_name,
  levels = rev(country_order)
)
```

```{r}
# Create custom theme
custom_theme <- theme_minimal(base_size = 12) +
  theme(
    text = element_text(family = "Verdana"),
    panel.background = element_rect(fill = "papayawhip", color = NA),
    plot.background = element_rect(fill = "papayawhip", color = NA),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = "bottom",
    axis.text = element_text(colour = "black"),
    axis.title = element_blank(),
    plot.title = element_text(
      size = rel(1.2),
      face = "bold",
      hjust = 0,
      margin = margin(t = 5, b = 8)
    ),
    plot.margin = margin(t = 10, r = 15, b = 15, l = 10),
    # Use ggtext to allow markdown formatting in the subtitle
    plot.subtitle = ggtext::element_markdown(
      hjust = 0,
      margin = margin(b = 10)
    ),
    plot.caption = element_text(
      hjust = 0,
      margin = margin(t = 10)
    )
  )
```

```{r}
subtitle <-
  "From conflict-affected regions. These include refugees, internally displaced persons (IDPs), <br>asylum seekers, and others."

ggplot(
  under_5_heatmap,
  aes(x = (year), y = country_name, fill = total / 1e6) # in millions
) +
  geom_tile(color = "grey", linewidth = 0.3) +
  scale_x_continuous(breaks = seq(2000, 2024, by = 4), expand = c(0, 0)) +
  scale_fill_scico(palette = "berlin") +
  guides(
    fill = guide_colorbar(
      barwidth = 14,
      barheight = 0.65
    )
  ) +
  labs(
    title = "Forcibly Displaced Children Under Age 5 (in millions)",
    subtitle = subtitle,
    caption = "Note: Preliminary view of displacement. 2025 data pending; underreporting in Palestine; other age groups, unknown \nand stateless populations not shown.
    \nData: {Refugees} R package (UNHCR) â€¢ Visualization: Darakhshan Nehal",
    x = NULL,
    y = NULL,
    fill = NULL
  ) +
  custom_theme

```

```{r}
# Save plot
ggsave("demography_heatmap.png", width = 9, height = 5, dpi = 300)

```